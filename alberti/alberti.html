<!DOCTYPE html
PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<head>
<title>Alberti Cipher Disk</title>
<link rel="stylesheet" type="text/css" href="styles.css"/>
<script src="../js/jquery-2.1.0.js"></script>
<script src="../js/raphael-min.js"></script>
</head>

<body>
<div id="holder"></div>
<div id="wheelinfo"></div>

<script>

holder_id = 'holder';
holder = '#' + holder_id;
startRotation = 0;
wheelIsRotating = false;
totalRotations = 52;
oneRotAngle = 360.0 / totalRotations;

default_text = 'Click wheel to rotate.';
stop_text = 'Click wheel to stop rotating.';

// Based on http://inventwithpython.com/cipherwheel/
function getAngle(e) {
    var PI = 3.1415926535;
    var wheeloffset = $(holder).offset();
    var wheelwidth = $(holder).width();
    var wheelheight = $(holder).height();
    var originx = wheeloffset.left + (wheelwidth / 2);
    var originy = wheeloffset.top + (wheelheight / 2);

    var x = e.pageX - originx;
    var y = e.pageY - originy;

    if (x == 0) {
        if (y <= 0) {
            return 90.0;
        }
        else {
            return 270.0;
        }
    }
    var slope = (y / x);
    var angle = Math.atan( slope ) * (180 / PI);

    if (y >= 0 && x >= 0) {
        angle = (90 - angle) + 270.0;
    }
    if (y >= 0 && x < 0) {
        angle = -angle + 180.0;
    }
    if( y < 0 && x < 0) {
        angle = (90 - angle) + 90.0;
    }
    if (y < 0 && x >= 0) {
        angle = -angle;
    }

    if (angle == 360.0) {
        return 0.0;
    }
    else {
        return angle;
    }
}

function showRotation(n) {
    var angle = 360.0 / totalRotations * n;
    img.animate({transform: "r" + angle}, 0);
}


function clickCipherWheel(e) {
    var angle = getAngle(e);

    if (wheelIsRotating) {
        wheelIsRotating = false;
        $('#wheelinfo').html(default_text);
        adjustment = parseInt((startAngle - angle) / oneRotAngle);
        startRotation = (adjustment + startRotation) % totalRotations;
        return;
    }
    else {
        startAngle = angle;
        wheelIsRotating = true;
        $('#wheelinfo').html(stop_text);
    }
}


function rotateCipherWheel(e) {
    if (!wheelIsRotating) {
        return;
    }
    adjustment = parseInt((startAngle - getAngle(e)) / oneRotAngle);
    currentRotation = (adjustment + startRotation) % totalRotations;
    showRotation(currentRotation);
}

function prepareAll() {
    $(holder).click(clickCipherWheel);
    $(holder).mousemove(rotateCipherWheel);

    Raphael.fn.disks = function (cx, cy, r) {
        var paper = this;
        var imgX = 300,
            imgY = 300;
        img_inner = paper.image("img/alberti_inner.png",cx - imgX/2, cy - imgY/2, imgX, imgY);
        img = paper.image("img/alberti_outer.png", cx - imgX/2, cy - imgY/2, imgX, imgY);
    }
}

$(document).ready(function() {
    var width = 400,
        height = 400,
        diskx = width / 2,
        disky = height / 2,
        diskrad = 100;
    prepareAll();
    $('#wheelinfo').html(default_text);    
    Raphael(holder_id, width, height).disks(diskx, disky, diskrad);
});
</script>


</body>
</html>
