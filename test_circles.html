<!DOCTYPE html
PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<head>
<title>Alberti Cipher Disk</title>
<script src="jquery-2.1.0.js"></script>
<script src="raphael.js"></script>
</head>

<body>
<div id="holder" style="border: solid 3px #000; width: auto; display: inline-block;"></div>
<div id="wheelinfo" style="text-align: center;">Click wheel to rotate.</div>
<script>

holder = '#holder'
startRotation = 0;
wheelIsRotating = false;
totalRotations = 52;
oneRotAngle = 360.0 / totalRotations;

// from http://inventwithpython.com/cipherwheel/
function getAngle(e) {
    var wheeloffset = $(holder).offset();
    var wheelwidth = $(holder).width();
    var wheelheight = $(holder).height();
    var originx = wheeloffset.left + (wheelwidth / 2);
    var originy = wheeloffset.top + (wheelheight / 2);

    var x = e.pageX - originx;
    var y = e.pageY - originy;

    if (x == 0) {
        if (y <= 0) {
            return 90.0;
        }
        else {
            return 270.0;
        }
    }
    var slope = (y / x);
    var angle = Math.atan( slope ) * (180 / 3.141592);

    if (y >= 0 && x >= 0) {
        angle = (90 - angle) + 270.0;
    }
    if (y >= 0 && x < 0) {
        angle = -angle + 180.0;
    }
    if( y < 0 && x < 0) {
        angle = (90 - angle) + 90.0;
    }
    if (y < 0 && x >= 0) {
        angle = -angle;
    }

    if (angle == 360.0) {
        return 0.0;
    }
    else {
        return angle;
    }
}

function showRotation(n) {
    var angle = 360.0 / totalRotations * n;
    img.animate({transform: "r" + angle}, 0);
}

function clickCipherWheel(e) {
    var angle = getAngle(e);

    if (wheelIsRotating) {
        wheelIsRotating = false;
        $('#wheelinfo').html('Click wheel to rotate.');
        adjustment = parseInt((startAngle - angle) / oneRotAngle);
        startRotation = (adjustment + startRotation) % totalRotations;
        return;
    }
    else {
        startAngle = angle;
        wheelIsRotating = true;
        $('#wheelinfo').html('Click wheel to stop rotating.');
    }
}


function rotateCipherWheel(e) {
    if (!wheelIsRotating) {
        return;
    }
    adjustment = parseInt((startAngle - getAngle(e)) / oneRotAngle);
    currentRotation = (adjustment + startRotation) % totalRotations;
    showRotation(currentRotation);
}

$(holder).click( clickCipherWheel );
$(holder).mousemove( rotateCipherWheel );

Raphael.fn.disks = function (cx, cy, r) {
    var paper = this;

    var c1 = paper.circle(cx, cy, r + 20);
    c1.attr("fill", "#f0f");
    c1.attr("stroke", "#fff");

    var imgX = 300,
        imgY = 300;
    img = paper.image("disk.png", cx - imgX/2, cy - imgY/2, imgX, imgY);
}


var width = 400,
    height = 400,
    diskx = width / 2,
    disky = height / 2,
    diskrad = 100;

$(document).ready(function() {
    Raphael("holder", width, height).disks(diskx, disky, diskrad);
});

</script>
</body>
</html>
